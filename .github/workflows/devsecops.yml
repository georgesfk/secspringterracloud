name: DevSecOps Secure Platform Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸ” Stage 1: Security and Code Quality Analysis
  security-scan:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    outputs:
      gitleaks-passed: ${{ steps.gitleaks.outcome }}
      semgrep-passed: ${{ steps.semgrep.outcome }}
      dependency-check-passed: ${{ steps.dependency-check.outcome }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ğŸ” Gitleaks Secret Detection
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ğŸ” Semgrep SAST Scan
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            security-configs/semgrep-rules.yml
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: â˜• Maven Dependency Check
        id: dependency-check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Secure Platform Backend'
          path: './backend-springboot'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --suppressionFile security-configs/suppressions.xml
            --failOnCVSS 7

      - name: ğŸ“Š Upload Security Scan Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-results
          path: |
            semgrep.sarif
            reports/
          retention-days: 30

  # ğŸ§ª Stage 2: Testing and Quality Assurance
  test-quality:
    name: ğŸ§ª Testing & Quality
    runs-on: ubuntu-latest
    needs: security-scan
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Testing
      - name: â˜• Set up JDK 17
        if: matrix.component == 'backend'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ§ª Backend Tests
        if: matrix.component == 'backend'
        run: |
          cd backend-springboot
          mvn clean test -DskipTests=false
          
      - name: ğŸ“Š Generate Test Report
        if: matrix.component == 'backend'
        uses: dorny/test-reporter@v1
        with:
          name: Backend Test Results
          path: backend-springboot/target/surefire-reports/*.xml
          reporter: java-junit

      # Frontend Testing
      - name: ğŸŸ¢ Set up Node.js
        if: matrix.component == 'frontend'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend-angular/package-lock.json

      - name: ğŸ“¦ Install Frontend Dependencies
        if: matrix.component == 'frontend'
        run: |
          cd frontend-angular
          npm ci

      - name: ğŸ§ª Frontend Tests
        if: matrix.component == 'frontend'
        run: |
          cd frontend-angular
          npm run test -- --watch=false --browsers=ChromeHeadless

      - name: ğŸ“ Lint Frontend Code
        if: matrix.component == 'frontend'
        run: |
          cd frontend-angular
          npm run lint

  # ğŸ—ï¸ Stage 3: Build and Container Security
  build-container:
    name: ğŸ—ï¸ Build & Container Security
    runs-on: ubuntu-latest
    needs: [security-scan, test-quality]
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.component == 'backend' && 'Dockerfile.backend' || 'Dockerfile.frontend' }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ğŸ” Container Security Scanning with Trivy
      - name: ğŸ” Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ” Trivy Image Scan
        run: |
          trivy image --format json --output trivy-report.json ${{ steps.meta.outputs.tags }}
          
      - name: ğŸ“Š Upload Trivy Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-scan-report-${{ matrix.component }}
          path: trivy-report.json

  # ğŸŒ Stage 4: Dynamic Application Security Testing
  dast-scan:
    name: ğŸŒ DAST Security Testing
    runs-on: ubuntu-latest
    needs: build-container
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Start Application with Docker Compose
        run: |
          docker-compose up -d
          sleep 30  # Wait for services to start
          
      - name: ğŸ” OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: 'security-configs/owasp-zap-config.xml'
          cmd_options: '-a'
          
      - name: ğŸ“Š OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: 'security-configs/owasp-zap-config.xml'
          cmd_options: '-a'
          
      - name: ğŸ” Custom Security Tests
        run: |
          # Custom security test scripts
          ./scripts/security-tests.sh
          
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          docker-compose down -v

  # â˜¸ï¸ Stage 5: Kubernetes Deployment (if configured)
  kubernetes-deploy:
    name: â˜¸ï¸ Kubernetes Deployment
    runs-on: ubuntu-latest
    needs: [build-container, dast-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ğŸ”‘ Configure Kubernetes Context
        run: |
          aws eks update-kubeconfig --name secure-platform-eks --region us-east-1

      - name: ğŸ›¡ï¸ Scan Kubernetes Manifests
        run: |
          kube-score score k8s/*.yaml
          polaris audit --config policy.yaml

      - name: â˜¸ï¸ Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/secure-platform-backend
          kubectl rollout status deployment/secure-platform-frontend

  # â˜ï¸ Stage 6: Cloud Security and Compliance
  cloud-security:
    name: â˜ï¸ Cloud Security
    runs-on: ubuntu-latest
    needs: kubernetes-deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: ğŸ” AWS Config Compliance Check
        run: |
          aws configservice get-compliance-summary \
            --compliance-types AWS::Config::ResourceCompliance
            
      - name: ğŸ” IAM Security Audit
        run: |
          aws iam generate-credential-report
          aws iam get-credential-report --query 'Content' --output text | base64 -d | cut -d, -f1,5,11,16

  # ğŸ“Š Stage 7: Security Reporting and Notifications
  security-report:
    name: ğŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, dast-scan, cloud-security]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“Š Download All Artifacts
        uses: actions/download-artifact@v3

      - name: ğŸ“‹ Generate Security Report
        run: |
          ./scripts/generate-security-report.sh

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.html

      - name: ğŸ“§ Send Security Notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ğŸš¨ DevSecOps Pipeline Security Alert
            Job: ${{ job.status }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref }}
            Repository: ${{ github.repository }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ğŸ¯ Stage 8: Final Quality Gate
  quality-gate:
    name: ğŸ¯ Quality Gate
    runs-on: ubuntu-latest
    needs: [security-scan, dast-scan, build-container]
    if: always()
    
    steps:
      - name: âœ… Quality Gate Check
        run: |
          # Check if all security gates passed
          if [ "${{ needs.security-scan.outputs.gitleaks-passed }}" != "success" ]; then
            echo "âŒ Gitleaks security scan failed"
            exit 1
          fi
          
          if [ "${{ needs.security-scan.outputs.semgrep-passed }}" != "success" ]; then
            echo "âŒ Semgrep SAST scan failed"
            exit 1
          fi
          
          echo "âœ… All security gates passed!"
          echo "ğŸ”’ Secure Platform is ready for deployment"

      - name: ğŸ‰ Deployment Approval
        if: success()
        run: |
          echo "ğŸš€ All security checks passed!"
          echo "ğŸ† Secure Platform DevSecOps pipeline completed successfully"
          echo "ğŸ” Security Status: COMPLIANT"
          echo "ğŸ“Š OWASP Top 10: COVERED"
          echo "ğŸ›¡ï¸ Container Security: VERIFIED"
          echo "ğŸŒ DAST Scanning: COMPLETED"

  # ğŸ”„ Stage 9: Post-Deployment Security Monitoring
  post-deployment:
    name: ğŸ”„ Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [quality-gate, kubernetes-deploy]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Post-Deployment Security Check
        run: |
          # Run post-deployment security validation
          ./scripts/post-deployment-security-check.sh
          
      - name: ğŸ“Š Performance Security Metrics
        run: |
          # Collect security-related performance metrics
          ./scripts/security-metrics.sh
          
      - name: ğŸ”” Security Team Notification
        if: always()
        run: |
          # Notify security team of successful deployment
          echo "âœ… Secure Platform deployed successfully with all security checks passed"
