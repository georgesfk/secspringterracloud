# Semgrep Rules for Secure Platform DevSecOps

# Java Security Rules
rules:
  - id: java-hardcoded-secret
    patterns:
      - pattern-regex: '(?i)(password|secret|key|token)\s*[=:]\s*["\047`][^"\047`]{8,}["\047`]'
      - pattern-regex: '(?i)(api[_-]?key|secret[_-]?key)\s*[=:]\s*["\047`][^"\047`]{16,}["\047`]'
    message: Hardcoded secret detected. Use environment variables or secure vault.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-798: Use of Hard-coded Credentials'

  - id: java-sql-injection
    patterns:
      - pattern: |
          $STMT = $CON.$METHOD($QUERY + $VAR)
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (prepareStatement|createStatement|executeQuery)
    message: Potential SQL injection vulnerability detected.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A03:2021 – Injection'
      cwe: 'CWE-89: SQL Injection'

  - id: java-xss
    patterns:
      - pattern: |
          $RESPONSE.$METHOD($REQUEST.$GETPARAM($PARAM))
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (getWriter|getOutputStream)
    message: Potential XSS vulnerability detected.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A03:2021 – Injection'
      cwe: 'CWE-79: Cross-site Scripting'

  - id: java-weak-crypto
    patterns:
      - pattern-regex: '(?i)(md5|sha1|des)'
    message: Weak cryptographic algorithm detected. Use stronger alternatives.
    languages: [java]
    severity: WARNING
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-327: Use of a Broken or Risky Cryptographic Algorithm'

  - id: java-insecure-random
    patterns:
      - pattern: |
          new java.util.Random()
    message: Use SecureRandom instead of Random for security-sensitive operations.
    languages: [java]
    severity: WARNING
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-330: Use of Insufficiently Random Values'

  - id: java-jwt-none-algorithm
    patterns:
      - pattern: |
          $JWT.$METHOD(..., "none")
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (sign|verify)
    message: JWT with "none" algorithm detected. Always specify a secure algorithm.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-347: Improper Verification of Cryptographic Signature'

  - id: java-ssrf
    patterns:
      - pattern: |
          $URL = $REQUEST.$GETPARAM("url")
          ...
          $CLIENT.$METHOD($URL)
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (openConnection|openStream|getInputStream)
    message: Potential SSRF vulnerability detected. Validate and sanitize URL parameters.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A10:2021 – Server-Side Request Forgery'
      cwe: 'CWE-918: Server-Side Request Forgery'

  - id: java-xxe
    patterns:
      - pattern: |
          $FACTORY = $SAXFACTORY.$CONSTRUCTOR()
          ...
          $UNMARSHALLER = $FACTORY.$METHOD()
    message: Potential XXE vulnerability. Disable external entity processing.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A03:2021 – Injection'
      cwe: 'CWE-611: Improper Restriction of XML External Entity Reference'

  - id: java-unsafe-deserialization
    patterns:
      - pattern: |
          $OBJECT = $IO.$METHOD($STREAM)
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (readObject|readUnshared)
    message: Unsafe deserialization detected. Validate input and use safe alternatives.
    languages: [java]
    severity: ERROR
    metadata:
      owasp: 'A08:2021 – Software and Data Integrity Failures'
      cwe: 'CWE-502: Deserialization of Untrusted Data'

  - id: java-verbose-error
    patterns:
      - pattern: |
          $EX.printStackTrace()
    message: Verbose error logging detected. Use proper logging framework.
    languages: [java]
    severity: WARNING
    metadata:
      owasp: 'A09:2021 – Security Logging and Monitoring Failures'
      cwe: 'CWE-532: Information Exposure Through Log Files'

# TypeScript/Angular Security Rules
  - id: typescript-hardcoded-secret
    patterns:
      - pattern-regex: '(?i)(password|secret|key|token)\s*[=:]\s*["\047`][^"\047`]{8,}["\047`]'
      - pattern-regex: '(?i)(api[_-]?key|secret[_-]?key)\s*[=:]\s*["\047`][^"\047`]{16,}["\047`]'
    message: Hardcoded secret detected. Use environment variables or secure vault.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-798: Use of Hard-coded Credentials'

  - id: typescript-xss
    patterns:
      - pattern: |
          $ELEMENT.$METHOD = $USERINPUT
      - metavariable-pattern:
          metavariable: $METHOD
          pattern: (innerHTML|outerHTML)
    message: Potential XSS vulnerability. Use textContent or sanitize input.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      owasp: 'A03:2021 – Injection'
      cwe: 'CWE-79: Cross-site Scripting'

  - id: typescript-eval-usage
    patterns:
      - pattern: |
          eval($INPUT)
      - pattern: |
          Function($INPUT)
    message: Dynamic code execution detected. Avoid eval() and Function constructor.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      owasp: 'A03:2021 – Injection'
      cwe: 'CWE-94: Improper Control of Generation of Code'

  - id: typescript-insecure-random
    patterns:
      - pattern: |
          Math.random()
    message: Math.random() is not cryptographically secure. Use crypto.getRandomValues().
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-330: Use of Insufficiently Random Values'

# General Security Patterns
  - id: http-insecure-headers
    patterns:
      - pattern-regex: '(?i)(x-frame-options|content-security-policy|strict-transport-security|x-content-type-options)'
    message: Security headers should be properly configured.
    languages: [generic]
    severity: WARNING
    metadata:
      owasp: 'A05:2021 – Security Misconfiguration'
      cwe: 'CWE-16: Configuration'

  - id: http-insecure-protocols
    patterns:
      - pattern-regex: '(?i)(http://|ftp://)'
    message: Insecure protocol detected. Use HTTPS instead.
    languages: [generic]
    severity: ERROR
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      cwe: 'CWE-319: Cleartext Transmission of Sensitive Information'

# DevSecOps Specific Rules
  - id: docker-sudo-usage
    patterns:
      - pattern-regex: '(?i)(sudo|run-as-root)'
    message: Avoid running containers as root or using sudo.
    languages: [dockerfile]
    severity: WARNING
    metadata:
      owasp: 'A01:2021 – Broken Access Control'
      cwe: 'CWE-269: Improper Privilege Management'

  - id: docker-insecure-base-image
    patterns:
      - pattern-regex: '(?i)(from\s+[^:]*:latest|from\s+[^:]*:[^0-9]*alpine[^0-9]*)'
    message: Use specific version tags and regularly updated base images.
    languages: [dockerfile]
    severity: WARNING
    metadata:
      owasp: 'A06:2021 – Vulnerable and Outdated Components'
      cwe: 'CWE-1104: Use of Unmaintained Third Party Components'
